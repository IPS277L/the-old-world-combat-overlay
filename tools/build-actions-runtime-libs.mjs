import fs from "fs";
import path from "path";

const toolsDir = path.resolve(path.dirname(new URL(import.meta.url).pathname));
const macrosDir = path.resolve(toolsDir, "..");
const actionsPartsDir = path.join(macrosDir, "src", "actions");
const runtimeDir = path.join(macrosDir, "libs", "actions-runtime");

const orderedParts = [
  { key: "00-core", file: "00-core.js" },
  { key: "10-attack-flow", file: "10-attack-flow.js" },
  { key: "20-defence-flow", file: "20-defence-flow.js" },
  { key: "30-api", file: "30-api.js" }
];

const BUNDLE_KEY = "towActionsRuntimeBundleV1";
const RUNTIME_VERSION = "1.0.0";

fs.mkdirSync(runtimeDir, { recursive: true });

for (const part of orderedParts) {
  const sourcePath = path.join(actionsPartsDir, part.file);
  const source = fs.readFileSync(sourcePath, "utf8");
  const sourceLiteral = JSON.stringify(source);

  const runtimeMacro = `// Auto-generated by macros/tools/build-actions-runtime-libs.mjs
// Registers actions runtime source part: ${part.key}
(() => {
  const bundle = game["${BUNDLE_KEY}"] ?? (game["${BUNDLE_KEY}"] = {
    version: "${RUNTIME_VERSION}",
    parts: new Map(),
    order: ${JSON.stringify(orderedParts.map((p) => p.key))}
  });
  bundle.version = "${RUNTIME_VERSION}";
  if (!(bundle.parts instanceof Map)) bundle.parts = new Map();
  bundle.parts.set(${JSON.stringify(part.key)}, ${sourceLiteral});
})();
`;

  const outFile = path.join(runtimeDir, `tow-actions-runtime-part-${part.key}-v1.js`);
  fs.writeFileSync(outFile, runtimeMacro);
}

const loaderMacro = `// Auto-generated by macros/tools/build-actions-runtime-libs.mjs
// Assembles registered runtime parts and executes actions API registration.
(() => {
  const BUNDLE_KEY = "${BUNDLE_KEY}";
  const bundle = game[BUNDLE_KEY];
  const order = ${JSON.stringify(orderedParts.map((p) => p.key))};

  if (!bundle || !(bundle.parts instanceof Map)) {
    ui.notifications.error("Actions runtime bundle not initialized. Execute runtime part macros first.");
    return;
  }

  const missing = order.filter((key) => !bundle.parts.has(key));
  if (missing.length) {
    ui.notifications.error(\`Actions runtime bundle incomplete. Missing: \${missing.join(", ")}\`);
    return;
  }

  const source = order.map((key) => String(bundle.parts.get(key) ?? "")).join("\\n\\n");
  const signature = \`\${bundle.version ?? "0"}:\${source.length}\`;
  if (game.towActions?.version && bundle.compiledSignature === signature) return;

  try {
    const run = new Function(source);
    run();
    bundle.compiledSignature = signature;
  } catch (error) {
    console.error("[tow-actions-runtime] Failed to compile actions runtime bundle.", error);
    ui.notifications.error("Failed to compile actions runtime bundle.");
  }
})();
`;

fs.writeFileSync(path.join(runtimeDir, "tow-actions-runtime-loader-v1.js"), loaderMacro);
console.log(`Built actions runtime macros in ${runtimeDir}`);
