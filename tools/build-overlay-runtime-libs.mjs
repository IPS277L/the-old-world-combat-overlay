import fs from "fs";
import path from "path";

const toolsDir = path.resolve(path.dirname(new URL(import.meta.url).pathname));
const macrosDir = path.resolve(toolsDir, "..");
const overlayPartsDir = path.join(macrosDir, "src", "overlay");
const runtimeDir = path.join(macrosDir, "libs", "overlay-runtime");

const orderedParts = [
  { key: "00-header-and-combat", file: "00-header-and-combat.js" },
  { key: "10-layout-and-state", file: "10-layout-and-state.js" },
  { key: "20-controls", file: "20-controls.js" },
  { key: "30-status-and-api", file: "30-status-and-api.js" }
];

const BUNDLE_KEY = "towOverlayRuntimeBundleV1";
const RUNTIME_VERSION = "1.0.0";

fs.mkdirSync(runtimeDir, { recursive: true });

for (const part of orderedParts) {
  const sourcePath = path.join(overlayPartsDir, part.file);
  const source = fs.readFileSync(sourcePath, "utf8");
  const sourceLiteral = JSON.stringify(source);

  const runtimeMacro = `// Auto-generated by macros/tools/build-overlay-runtime-libs.mjs
// Registers overlay runtime source part: ${part.key}
(() => {
  const bundle = game["${BUNDLE_KEY}"] ?? (game["${BUNDLE_KEY}"] = {
    version: "${RUNTIME_VERSION}",
    parts: new Map(),
    order: ${JSON.stringify(orderedParts.map((p) => p.key))}
  });
  bundle.version = "${RUNTIME_VERSION}";
  if (!(bundle.parts instanceof Map)) bundle.parts = new Map();
  bundle.parts.set(${JSON.stringify(part.key)}, ${sourceLiteral});
})();
`;

  const outFile = path.join(runtimeDir, `tow-overlay-runtime-part-${part.key}-v1.js`);
  fs.writeFileSync(outFile, runtimeMacro);
}

const loaderMacro = `// Auto-generated by macros/tools/build-overlay-runtime-libs.mjs
// Assembles registered runtime parts and executes overlay API registration.
(() => {
  const BUNDLE_KEY = "${BUNDLE_KEY}";
  const bundle = game[BUNDLE_KEY];
  const order = ${JSON.stringify(orderedParts.map((p) => p.key))};

  if (!bundle || !(bundle.parts instanceof Map)) {
    ui.notifications.error("Overlay runtime bundle not initialized. Execute runtime part macros first.");
    return;
  }

  const missing = order.filter((key) => !bundle.parts.has(key));
  if (missing.length) {
    ui.notifications.error(\`Overlay runtime bundle incomplete. Missing: \${missing.join(", ")}\`);
    return;
  }

  const source = order.map((key) => String(bundle.parts.get(key) ?? "")).join("\\n\\n");
  const signature = \`\${bundle.version ?? "0"}:\${source.length}\`;
  if (game.towOverlay?.version && bundle.compiledSignature === signature) return;

  try {
    const run = new Function(source);
    run();
    bundle.compiledSignature = signature;
  } catch (error) {
    console.error("[tow-overlay-runtime] Failed to compile overlay runtime bundle.", error);
    ui.notifications.error("Failed to compile overlay runtime bundle.");
  }
})();
`;

fs.writeFileSync(path.join(runtimeDir, "tow-overlay-runtime-loader-v1.js"), loaderMacro);
console.log(`Built overlay runtime macros in ${runtimeDir}`);
