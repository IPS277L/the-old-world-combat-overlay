// Auto-generated by macros/tools/build-overlay-runtime-libs.mjs
// Assembles registered runtime parts and executes overlay API registration.
(() => {
  const BUNDLE_KEY = "towOverlayRuntimeBundleV1";
  const bundle = game[BUNDLE_KEY];
  const order = ["00-header-and-combat","10-layout-and-state","20-controls","30-status-and-api"];

  if (!bundle || !(bundle.parts instanceof Map)) {
    ui.notifications.error("Overlay runtime bundle not initialized. Execute runtime part macros first.");
    return;
  }

  const missing = order.filter((key) => !bundle.parts.has(key));
  if (missing.length) {
    ui.notifications.error(`Overlay runtime bundle incomplete. Missing: ${missing.join(", ")}`);
    return;
  }

  const source = order.map((key) => String(bundle.parts.get(key) ?? "")).join("\n\n");
  const signature = `${bundle.version ?? "0"}:${source.length}`;
  if (game.towOverlay?.version && bundle.compiledSignature === signature) return;

  try {
    const run = new Function(source);
    run();
    bundle.compiledSignature = signature;
  } catch (error) {
    console.error("[tow-overlay-runtime] Failed to compile overlay runtime bundle.", error);
    ui.notifications.error("Failed to compile overlay runtime bundle.");
  }
})();
