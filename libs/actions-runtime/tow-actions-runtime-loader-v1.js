// Auto-generated by macros/tools/build-actions-runtime-libs.mjs
// Assembles registered runtime parts and executes actions API registration.
(() => {
  const BUNDLE_KEY = "towActionsRuntimeBundleV1";
  const bundle = game[BUNDLE_KEY];
  const order = ["00-core","10-attack-flow","20-defence-flow","30-api"];

  if (!bundle || !(bundle.parts instanceof Map)) {
    ui.notifications.error("Actions runtime bundle not initialized. Execute runtime part macros first.");
    return;
  }

  const missing = order.filter((key) => !bundle.parts.has(key));
  if (missing.length) {
    ui.notifications.error(`Actions runtime bundle incomplete. Missing: ${missing.join(", ")}`);
    return;
  }

  const source = order.map((key) => String(bundle.parts.get(key) ?? "")).join("\n\n");
  const signature = `${bundle.version ?? "0"}:${source.length}`;
  if (game.towActions?.version && bundle.compiledSignature === signature) return;

  try {
    const run = new Function(source);
    run();
    bundle.compiledSignature = signature;
  } catch (error) {
    console.error("[tow-actions-runtime] Failed to compile actions runtime bundle.", error);
    ui.notifications.error("Failed to compile actions runtime bundle.");
  }
})();
