// Auto-generated by macros/tools/build-actions-runtime-libs.mjs
// Registers actions runtime source part: 20-defence-flow
(() => {
  const bundle = game["towActionsRuntimeBundleV1"] ?? (game["towActionsRuntimeBundleV1"] = {
    version: "1.0.0",
    parts: new Map(),
    order: ["00-core","10-attack-flow","20-defence-flow","30-api"]
  });
  bundle.version = "1.0.0";
  if (!(bundle.parts instanceof Map)) bundle.parts = new Map();
  bundle.parts.set("20-defence-flow", "function getSkillLabel(skill) {\n  return game.oldworld?.config?.skills?.[skill] ?? skill;\n}\n\nfunction getCharacteristicLabel(characteristic) {\n  return game.oldworld?.config?.characteristics?.[characteristic]\n    ?? game.oldworld?.config?.characteristicAbbrev?.[characteristic]\n    ?? characteristic;\n}\n\nfunction getActorSkills(actor) {\n  const skills = Object.keys(actor.system?.skills ?? {}).filter((skill) => {\n    const skillData = actor.system?.skills?.[skill];\n    return skillData && typeof skillData.value !== \"undefined\";\n  });\n\n  // Match NPC token-sheet ordering (alpha by skill key).\n  return skills.sort((a, b) => a.localeCompare(b));\n}\n\nfunction getActorCharacteristics(actor) {\n  return Object.keys(actor.system?.characteristics ?? {}).filter((characteristic) => {\n    const value = Number(actor.system?.characteristics?.[characteristic]?.value ?? NaN);\n    return Number.isFinite(value);\n  });\n}\n\nfunction getManualDefenceEntries(actor) {\n  const skillEntries = getActorSkills(actor).map((skill) => ({\n    type: \"skill\",\n    id: skill,\n    label: getSkillLabel(skill),\n    target: Number(actor.system?.skills?.[skill]?.value ?? 0)\n  }));\n\n  const charEntries = getActorCharacteristics(actor).map((characteristic) => ({\n    type: \"characteristic\",\n    id: characteristic,\n    label: getCharacteristicLabel(characteristic),\n    target: Number(actor.system?.characteristics?.[characteristic]?.value ?? 0)\n  }));\n\n  // Keep characteristics in native schema order to match sheet columns.\n  return [...skillEntries, ...charEntries];\n}\n\nfunction armAutoSubmitSkillDialog(actor, skill) {\n  armAutoSubmitDialog({\n    hookName: \"renderTestDialog\",\n    matches: (app) => app?.actor?.id === actor.id && app?.skill === skill,\n    submitErrorMessage: \"TestDialog.submit() is unavailable.\"\n  });\n}\n\nasync function rollSkill(actor, skill, { autoRoll = false } = {}) {\n  if (autoRoll) armAutoSubmitSkillDialog(actor, skill);\n  return actor.setupSkillTest(skill, SELF_ROLL_CONTEXT);\n}\n\nasync function rollCharacteristic(actor, characteristic) {\n  const OldWorldTestClass = game.oldworld?.config?.rollClasses?.OldWorldTest;\n  if (!OldWorldTestClass) {\n    ui.notifications.error(\"OldWorldTest roll class is unavailable.\");\n    return null;\n  }\n\n  const target = Number(actor.system?.characteristics?.[characteristic]?.value ?? 0);\n  if (!Number.isFinite(target) || target <= 0) {\n    ui.notifications.warn(`${actor.name}: characteristic '${characteristic}' has no valid value.`);\n    return null;\n  }\n\n  const data = {\n    actor,\n    skill: characteristic,\n    characteristic,\n    target,\n    dice: target,\n    bonus: 0,\n    penalty: 0,\n    glorious: 0,\n    grim: 0,\n    state: \"normal\",\n    loseTies: false,\n    rollMode: game.settings.get(\"core\", \"rollMode\"),\n    speaker: CONFIG.ChatMessage.documentClass.getSpeaker({ actor }),\n    targets: [],\n    context: {\n      title: game.i18n.format(\"TOW.Test.SkillTest\", { skill: getCharacteristicLabel(characteristic) }),\n      appendTitle: \"\",\n      endeavour: false,\n      action: undefined,\n      subAction: undefined,\n      itemUuid: undefined,\n      reload: undefined,\n      flags: undefined,\n      defending: actor.system.opposed?.id\n    }\n  };\n\n  const test = OldWorldTestClass.fromData(data);\n  await test.roll();\n  await test.sendToChat();\n  return test;\n}\n\nfunction renderDefenceSelector(actor, entries) {\n  const emphasizedSkills = new Set([\"defence\", \"athletics\", \"endurance\"]);\n  const renderEntryButton = (entry) => {\n      const id = escapeHtml(entry.id);\n      const type = escapeHtml(entry.type);\n      const value = Number(entry.target ?? 0);\n      const shouldEmphasize = entry.type === \"skill\" && emphasizedSkills.has(String(entry.id).toLowerCase());\n      return renderSelectorRowButton({\n        rowClass: \"skill-btn\",\n        dataAttrs: `data-type=\"${type}\" data-id=\"${id}\"`,\n        label: entry.label,\n        valueLabel: `T${value}`,\n        highlighted: shouldEmphasize,\n        compact: true\n      });\n  };\n\n  const characteristicEntries = entries.filter((entry) => entry.type === \"characteristic\");\n  const skillEntries = entries.filter((entry) => entry.type === \"skill\");\n\n  const characteristicMarkup = characteristicEntries.map(renderEntryButton).join(\"\");\n  const skillMarkup = skillEntries.map(renderEntryButton).join(\"\");\n\n  const content = `<div style=\"display:grid; grid-template-columns:1fr 1fr; gap:6px; align-items:start;\">\n    <div style=\"display:flex; flex-direction:column; min-width:0; border:1px solid #b9b6aa; border-radius:4px; overflow:hidden;\">\n      <div style=\"padding:4px 6px; font-size:12px; font-weight:700; background:#d9d5c7;\">Characteristics</div>\n      <div style=\"display:flex; flex-direction:column; gap:4px; padding:6px; overflow-y:auto; overflow-x:hidden; max-height:430px; scrollbar-gutter:stable;\">\n        ${characteristicMarkup || '<div style=\"font-size:12px; opacity:0.7;\">No characteristics</div>'}\n      </div>\n    </div>\n    <div style=\"display:flex; flex-direction:column; min-width:0; border:1px solid #b9b6aa; border-radius:4px; overflow:hidden;\">\n      <div style=\"padding:4px 6px; font-size:12px; font-weight:700; background:#d9d5c7;\">Skills</div>\n      <div style=\"display:flex; flex-direction:column; gap:4px; padding:6px; overflow-y:auto; overflow-x:hidden; max-height:430px; scrollbar-gutter:stable;\">\n        ${skillMarkup || '<div style=\"font-size:12px; opacity:0.7;\">No skills</div>'}\n      </div>\n    </div>\n  </div>`;\n\n  const selectorDialog = new Dialog({\n    title: `${actor.name} - Defence Roll`,\n    content,\n    width: 560,\n    height: 560,\n    buttons: { close: { label: \"Close\" } },\n    render: (html) => {\n      html.find(\".skill-btn\").on(\"click\", async (event) => {\n        const id = event.currentTarget.dataset.id;\n        const type = event.currentTarget.dataset.type;\n        if (!id || !type) return;\n        const fastRoll = event.shiftKey === true;\n        selectorDialog.close();\n\n        if (type === \"characteristic\") {\n          await rollCharacteristic(actor, id);\n          return;\n        }\n        await rollSkill(actor, id, { autoRoll: fastRoll });\n      });\n    }\n  });\n\n  selectorDialog.render(true);\n}\n");
})();
